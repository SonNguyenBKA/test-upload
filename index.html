<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Download QR</title>
    <style>
        .btn-download {
            padding: 15px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-download:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <div style="text-align: center; margin-top: 50px;">
        <svg id="qrImage" width="186" height="186" shape-rendering="crispEdges" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 41">
            <rect width="100%" height="100%" fill="#ffffff"></rect> <path fill="#38383D" d="M0 0h7v1H0zM8 0h1v1H8zM11 0h1v1H11zM14 0h2v1H14zM17 0h2v1H17zM21 0h1v1H21zM25 0h1v1H25zM27 0h1v1H27zM30 0h1v1H30zM34,0 h7v1H34zM0 1h1v1H0zM6 1h1v1H6zM8 1h1v1H8zM12 1h2v1H12zM15 1h2v1H15zM18 1h1v1H18zM20 1h1v1H20zM26 1h2v1H26zM30 1h1v1H30zM34 1h1v1H34zM40,1 h1v1H40zM0 2h1v1H0zM2 2h3v1H2zM6 2h1v1H6zM10 2h1v1H10zM12 2h3v1H12zM17 2h1v1H17zM19 2h2v1H19zM24 2h2v1H24zM28 2h2v1H28zM31 2h1v1H31zM34 2h1v1H34zM36 2h3v1H36zM40,2 h1v1H40zM0 3h1v1H0zM2 3h3v1H2zM6 3h1v1H6zM8 3h1v1H8zM11 3h1v1H11zM13 3h2v1H13zM16 3h1v1H16zM21 3h1v1H21zM23 3h1v1H23zM25 3h2v1H25zM29 3h1v1H29zM31 3h2v1H31zM34 3h1v1H34zM36 3h3v1H36zM40,3 h1v1H40zM0 4h1v1H0zM2 4h3v1H2zM6 4h1v1H6zM9 4h1v1H9zM12 4h4v1H12zM17 4h1v1H17zM19 4h1v1H19zM22 4h5v1H22zM29 4h1v1H29zM31 4h2v1H31zM34 4h1v1H34zM36 4h3v1H36zM40,4 h1v1H40zM0 5h1v1H0zM6 5h1v1H6zM11 5h1v1H11zM13 5h1v1H13zM16 5h1v1H16zM22 5h2v1H22zM28 5h2v1H28zM31 5h2v1H31zM34 5h1v1H34zM40,5 h1v1H40zM0 6h7v1H0zM8 6h1v1H8zM10 6h1v1H10zM12 6h1v1H12zM14 6h1v1H14zM16 6h1v1H16zM18 6h1v1H18zM20 6h1v1H20zM22 6h1v1H22zM24 6h1v1H24zM26 6h1v1H26zM28 6h1v1H28zM30 6h1v1H30zM32 6h1v1H32zM34,6 h7v1H34zM8 7h3v1H8zM12 7h1v1H12zM15 7h3v1H15zM20 7h2v1H20zM26 7h2v1H26zM29 7h1v1H29zM31 7h2v1H31zM0 8h1v1H0zM2 8h2v1H2zM5 8h3v1H5zM10 8h1v1H10zM15 8h2v1H15zM21 8h1v1H21zM23 8h1v1H23zM26 8h2v1H26zM29 8h1v1H29zM31 8h1v1H31zM34 8h1v1H34zM37 8h1v1H37zM39,8 h2v1H39zM0 9h1v1H0zM3 9h3v1H3zM7 9h1v1H7zM9 9h1v1H9zM13 9h3v1H13zM18 9h1v1H18zM21 9h1v1H21zM24 9h1v1H24zM26 9h4v1H26zM32 9h2v1H32zM35 9h2v1H35zM0 10h1v1H0zM2 10h2v1H2zM6 10h2v1H6zM9 10h1v1H9zM13 10h2v1H13zM16 10h3v1H16zM20 10h4v1H20zM26 10h1v1H26zM29 10h3v1H29zM33 10h4v1H33zM38 10h2v1H38zM1 11h4v1H1zM7 11h1v1H7zM10 11h1v1H10zM15 11h2v1H15zM20 11h1v1H20zM22 11h1v1H22zM28 11h1v1H28zM31 11h5v1H31zM37 11h1v1H37zM3 12h1v1H3zM6 12h4v1H6zM15 12h2v1H15zM18 12h1v1H18zM20 12h1v1H20zM22 12h1v1H22zM24 12h1v1H24zM27 12h1v1H27zM30 12h1v1H30zM32 12h1v1H32zM36 12h1v1H36zM40,12 h1v1H40zM1 13h3v1H1zM5 13h1v1H5zM7 13h2v1H7zM10 13h1v1H10zM13 13h1v1H13zM15 13h2v1H15zM20 13h1v1H20zM23 13h2v1H23zM26 13h1v1H26zM29 13h1v1H29zM32 13h4v1H32zM38 13h2v1H38zM2 14h2v1H2zM6 14h2v1H6zM9 14h1v1H9zM13 14h1v1H13zM15 14h9v1H15zM25 14h1v1H25zM27 14h1v1H27zM31 14h1v1H31zM34 14h1v1H34zM37 14h1v1H37zM39,14 h2v1H39zM0 15h1v1H0zM3 15h1v1H3zM5 15h1v1H5zM8 15h5v1H8zM14 15h1v1H14zM16 15h3v1H16zM21 15h1v1H21zM23 15h1v1H23zM27 15h1v1H27zM30 15h1v1H30zM32 15h2v1H32zM36 15h1v1H36zM39 15h1v1H39zM0 16h1v1H0zM3 16h1v1H3zM6 16h1v1H6zM8 16h1v1H8zM10 16h4v1H10zM26 16h1v1H26zM29 16h2v1H29zM32 16h1v1H32zM35 16h1v1H35zM38,16 h3v1H38zM0 17h1v1H0zM2 17h1v1H2zM7 17h2v1H7zM10 17h2v1H10zM14 17h1v1H14zM16 17h1v1H16zM21 17h6v1H21zM28 17h1v1H28zM30 17h1v1H30zM32 17h1v1H32zM34 17h2v1H34zM38 17h1v1H38zM3 18h1v1H3zM6 18h1v1H6zM9 18h3v1H9zM16 18h1v1H16zM18 18h2v1H18zM22 18h1v1H22zM24 18h1v1H24zM27 18h1v1H27zM30 18h2v1H30zM36 18h1v1H36zM40,18 h1v1H40zM1 19h1v1H1zM10 19h3v1H10zM17 19h2v1H17zM20 19h2v1H20zM23 19h2v1H23zM26 19h1v1H26zM29 19h2v1H29zM32 19h1v1H32zM35 19h1v1H35zM1 20h2v1H1zM6 20h1v1H6zM9 20h3v1H9zM15 20h1v1H15zM19 20h2v1H19zM23 20h1v1H23zM25 20h1v1H25zM27 20h1v1H27zM31 20h1v1H31zM34 20h1v1H34zM36 20h2v1H36zM39 20h1v1H39zM1 21h5v1H1zM7 21h4v1H7zM12 21h1v1H12zM21 21h1v1H21zM27 21h4v1H27zM35 21h2v1H35zM39 21h1v1H39zM0 22h1v1H0zM4 22h1v1H4zM6 22h1v1H6zM8 22h7v1H8zM16 22h2v1H16zM23 22h1v1H23zM26 22h1v1H26zM29 22h2v1H29zM33 22h1v1H33zM35 22h1v1H35zM37 22h1v1H37zM40,22 h1v1H40zM1 23h3v1H1zM5 23h1v1H5zM11 23h3v1H11zM15 23h2v1H15zM19 23h1v1H19zM21 23h1v1H21zM24 23h1v1H24zM28 23h1v1H28zM32 23h1v1H32zM34 23h1v1H34zM36 23h1v1H36zM38 23h1v1H38zM40,23 h1v1H40zM3 24h6v1H3zM10 24h1v1H10zM12 24h2v1H12zM16 24h1v1H16zM18 24h2v1H18zM21 24h1v1H21zM24 24h1v1H24zM29 24h1v1H29zM33 24h1v1H33zM36 24h2v1H36zM0 25h3v1H0zM5 25h1v1H5zM7 25h3v1H7zM11 25h1v1H11zM13 25h1v1H13zM15 25h3v1H15zM20 25h2v1H20zM23 25h1v1H23zM26 25h1v1H26zM30 25h1v1H30zM32 25h1v1H32zM36 25h1v1H36zM38 25h2v1H38zM0 26h1v1H0zM5 26h2v1H5zM10 26h1v1H10zM15 26h1v1H15zM21 26h2v1H21zM25 26h1v1H25zM28 26h1v1H28zM30 26h2v1H30zM33 26h3v1H33zM37 26h1v1H37zM39 26h1v1H39zM1 27h3v1H1zM7 27h2v1H7zM10 27h1v1H10zM14 27h3v1H14zM18 27h1v1H18zM24 27h1v1H24zM27 27h1v1H27zM30 27h2v1H30zM33 27h2v1H33zM36 27h1v1H36zM39 27h1v1H39zM4 28h1v1H4zM6 28h2v1H6zM10 28h1v1H10zM12 28h5v1H12zM18 28h1v1H18zM20 28h2v1H20zM23 28h2v1H23zM26 28h1v1H26zM29 28h1v1H29zM32 28h1v1H32zM35 28h1v1H35zM38 28h2v1H38zM1 29h1v1H1zM3 29h2v1H3zM9 29h2v1H9zM13 29h4v1H13zM19 29h3v1H19zM25 29h1v1H25zM28 29h1v1H28zM36 29h1v1H36zM0 30h1v1H0zM2 30h3v1H2zM6 30h1v1H6zM9 30h1v1H9zM12 30h4v1H12zM17 30h3v1H17zM21 30h2v1H21zM28 30h2v1H28zM33 30h3v1H33zM40,30 h1v1H40zM2 31h1v1H2zM8 31h3v1H8zM12 31h1v1H12zM15 31h1v1H15zM17 31h1v1H17zM19 31h1v1H19zM23 31h1v1H23zM26 31h1v1H26zM28 31h2v1H28zM31 31h1v1H31zM35 31h2v1H35zM38 31h1v1H38zM1 32h3v1H1zM6 32h1v1H6zM11 32h2v1H11zM14 32h2v1H14zM17 32h2v1H17zM21 32h1v1H21zM25 32h1v1H25zM27 32h3v1H27zM31 32h7v1H31zM39,32 h2v1H39zM8 33h2v1H8zM12 33h3v1H12zM16 33h3v1H16zM20 33h2v1H20zM23 33h1v1H23zM25 33h3v1H25zM29 33h2v1H29zM32 33h1v1H32zM36 33h1v1H36zM38 33h2v1H38zM0 34h7v1H0zM8 34h2v1H8zM11 34h1v1H11zM13 34h1v1H13zM15 34h1v1H15zM18 34h1v1H18zM20 34h1v1H20zM23 34h1v1H23zM25 34h1v1H25zM27 34h1v1H27zM30 34h1v1H30zM32 34h1v1H32zM34 34h1v1H34zM36 34h2v1H36zM40,34 h1v1H40zM0 35h1v1H0zM6 35h1v1H6zM8 35h2v1H8zM14 35h4v1H14zM19 35h2v1H19zM28 35h1v1H28zM31 35h2v1H31zM36 35h1v1H36zM39,35 h2v1H39zM0 36h1v1H0zM2 36h3v1H2zM6 36h1v1H6zM10 36h3v1H10zM14 36h3v1H14zM21 36h1v1H21zM23 36h2v1H23zM26 36h1v1H26zM29 36h2v1H29zM32 36h5v1H32zM39 36h1v1H39zM0 37h1v1H0zM2 37h3v1H2zM6 37h1v1H6zM8 37h3v1H8zM13 37h1v1H13zM15 37h2v1H15zM19 37h2v1H19zM22 37h2v1H22zM26 37h1v1H26zM29 37h1v1H29zM32 37h1v1H32zM35 37h1v1H35zM38 37h1v1H38zM0 38h1v1H0zM2 38h3v1H2zM6 38h1v1H6zM8 38h1v1H8zM12 38h5v1H12zM19 38h1v1H19zM25 38h1v1H25zM28 38h2v1H28zM31 38h1v1H31zM34 38h1v1H34zM37 38h1v1H37zM39,38 h2v1H39zM0 39h1v1H0zM6 39h1v1H6zM9 39h1v1H9zM12 39h4v1H12zM17 39h1v1H17zM21 39h1v1H21zM24 39h1v1H24zM27 39h1v1H27zM29 39h1v1H29zM31 39h1v1H31zM36 39h2v1H36zM39,39 h2v1H39zM0 40h7v1H0zM8 40h2v1H8zM12 40h1v1H12zM14 40h1v1H14zM16 40h2v1H16zM20 40h1v1H20zM26 40h1v1H26zM29 40h1v1H29zM33 40h2v1H33z"></path>
        </svg>
        <br>
        <button class="btn-download" onclick="handleDownload()">Download QR Code</button>
    </div>

    <script>
        function handleDownload() {
            const svgElement = document.getElementById('qrImage');
            const fileName = 'qrcode.png';
            
            // 1. Chuyển SVG thành chuỗi XML
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);

            // Thêm namespace nếu thiếu (quan trọng để vẽ lên canvas)
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            // 2. Tạo Blob từ SVG
            const svgBlob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(svgBlob);

            // 3. Tạo một ảnh Image ảo để chứa SVG
            const img = new Image();
            img.onload = function() {
                // 4. Vẽ ảnh lên Canvas
                const canvas = document.createElement("canvas");
                // Lấy kích thước thật của SVG
                const bbox = svgElement.getBoundingClientRect();
                canvas.width = bbox.width;
                canvas.height = bbox.height;
                
                const ctx = canvas.getContext("2d");
                // Vẽ ảnh
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // 5. Xuất Canvas ra file PNG và tải về
                canvas.toBlob(async function(blob) {
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    
                    if (isMobile && navigator.share) {
                        // Mobile: Dùng Share API
                        const file = new File([blob], fileName, { type: blob.type });
                        try {
                            await navigator.share({ files: [file] });
                        } catch (err) {
                            console.log('Share canceled', err);
                        }
                    } else {
                        // PC: Tải về bình thường
                        const link = document.createElement('a');
                        link.download = fileName;
                        link.href = URL.createObjectURL(blob);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    
                    // Dọn dẹp bộ nhớ
                    URL.revokeObjectURL(url); 
                }, 'image/png');
            };

            // Gán source cho ảnh ảo để kích hoạt hàm onload
            img.src = url;
        }
    </script>
</body>
</html>
